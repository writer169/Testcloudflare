<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - D1 Management</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
</head>

<body class="bg-black">
    <div id="root"></div>

    <script type="module">
      import React, { useState, useEffect } from "react";
      import ReactDOM from "react-dom/client";
      import {
        Plus, Key, Trash2, RefreshCw, Eye, EyeOff, Users, Package, Shield,
        CheckCircle, XCircle, Copy, Check, Award
      } from "lucide-react";

      const AdminPanel = () => {
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [masterKey, setMasterKey] = useState('');
        const [baseUrl, setBaseUrl] = useState('https://testcloudflare-t45.pages.dev');

        const [apps, setApps] = useState([]);
        const [users, setUsers] = useState([]);
        const [userApps, setUserApps] = useState([]);

        const [activeTab, setActiveTab] = useState('apps');
        const [showKeys, setShowKeys] = useState({});
        const [copiedKey, setCopiedKey] = useState('');

        const [newApp, setNewApp] = useState({ app_id: '', app_name: '' });
        const [newUser, setNewUser] = useState({ username: '', user_id: '', role: 'user' });

        const authenticate = async () => {
          if (!masterKey) return alert("Введите мастер-ключ");

          const response = await fetch(`${baseUrl}/api/admin`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${masterKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ action: "verify" })
          });

          if (response.ok) {
            setIsAuthenticated(true);
            loadData();
          } else {
            alert("Неверный мастер-ключ");
          }
        };

        const apiCall = async (action, data = {}) => {
          const res = await fetch(`${baseUrl}/api/admin`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${masterKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ action, ...data })
          });
          return res.json();
        };

        const loadData = async () => {
          try {
            const [appsRes, usersRes, userAppsRes] = await Promise.all([
              apiCall("list_apps"),
              apiCall("list_users"),
              apiCall("list_user_apps")
            ]);

            if (appsRes?.data) setApps(appsRes.data);
            if (usersRes?.data) setUsers(usersRes.data);
            if (userAppsRes?.data) setUserApps(userAppsRes.data);

          } catch (e) {}
        };

        const registerApp = async () => {
          if (!newApp.app_id || !newApp.app_name)
            return alert("Заполните все поля");

          const res = await apiCall("register_app", newApp);
          if (res.status === "ok") {
            alert(`Приложение создано\nКлюч:\n${res.app_key}`);
            setNewApp({ app_id: '', app_name: '' });
            loadData();
          }
        };

        const registerUser = async () => {
          if (!newUser.username) return alert("Введите имя");

          const res = await apiCall("register_user", newUser);
          if (res.status === "ok") {
            alert(`Пользователь создан!\nID: ${res.user_id}\nКлюч: ${res.user_key}`);
            setNewUser({ username: '', user_id: '', role: 'user' });
            loadData();
          }
        };

        const updateRole = async (uid, role) => {
          const r = await apiCall("update_role", { user_id: uid, role });
          if (r.status === "ok") loadData();
        };

        const regenerateKey = async (type, id) => {
          if (!confirm("Старый ключ перестанет работать. Продолжить?")) return;

          const action = type === "app" ? "regenerate_app_key" : "regenerate_user_key";
          const field = type === "app" ? "app_id" : "user_id";

          const r = await apiCall(action, { [field]: id });
          if (r.status === "ok") alert(`Новый ключ:\n${r.new_key}`);
          loadData();
        };

        const deleteItem = async (type, id) => {
          if (!confirm("Удалить?")) return;

          const action = type === "app" ? "delete_app" : "delete_user";
          const field = type === "app" ? "app_id" : "user_id";

          const r = await apiCall(action, { [field]: id });
          if (r.status === "ok") loadData();
        };

        const toggleAccess = async (uid, aid, has) => {
          const action = has ? "revoke_access" : "grant_access";
          await apiCall(action, { user_id: uid, app_id: aid });
          loadData();
        };

        const hasAccess = (uid, aid) =>
          userApps.some(a => a.user_id === uid && a.app_id === aid);

        const getRoleBadge = (role) => {
          const colors = {
            admin: "bg-red-500/20 text-red-400 border-red-500/30",
            user: "bg-blue-500/20 text-blue-400 border-blue-500/30",
            readonly: "bg-gray-500/20 text-gray-400 border-gray-500/30"
          };
          return colors[role] || colors.user;
        };

        if (!isAuthenticated) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4 text-white">
              <div className="bg-slate-800 p-6 rounded-xl w-full max-w-md">
                <h1 className="text-xl mb-4 flex items-center gap-2">
                  <Shield /> Admin Login
                </h1>

                <input className="w-full mb-3 p-2 rounded bg-slate-900 border border-slate-700"
                  value={baseUrl}
                  onChange={e => setBaseUrl(e.target.value)}
                />

                <input className="w-full mb-4 p-2 rounded bg-slate-900 border border-slate-700"
                  type="password"
                  value={masterKey}
                  onChange={e => setMasterKey(e.target.value)}
                />

                <button onClick={authenticate}
                  className="w-full bg-purple-600 py-2 rounded">
                  Войти
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen text-white p-6">
            <h1 className="text-3xl mb-4 flex items-center gap-2">
              <Shield /> Admin Panel
            </h1>

            {/* Tabs */}
            <div className="flex gap-2 mb-6">
              <button className={activeTab==="apps"?"bg-purple-600 px-4 py-2 rounded":"bg-slate-800 px-4 py-2 rounded"}
                onClick={()=>setActiveTab("apps")}>
                <Package size={18}/> Приложения
              </button>

              <button className={activeTab==="users"?"bg-purple-600 px-4 py-2 rounded":"bg-slate-800 px-4 py-2 rounded"}
                onClick={()=>setActiveTab("users")}>
                <Users size={18}/> Пользователи
              </button>

              <button className={activeTab==="access"?"bg-purple-600 px-4 py-2 rounded":"bg-slate-800 px-4 py-2 rounded"}
                onClick={()=>setActiveTab("access")}>
                <Key size={18}/> Доступы
              </button>
            </div>

            {/* CONTENT */}
            {/* Приложения */}
            {activeTab==="apps" && (
              <div className="space-y-4">

                <div className="bg-slate-800 p-4 rounded-xl">
                  <h2 className="text-xl mb-3">Добавить приложение</h2>

                  <input className="w-full mb-2 p-2 rounded bg-slate-900 border border-slate-700"
                    placeholder="App ID"
                    value={newApp.app_id}
                    onChange={e=>setNewApp({...newApp,app_id:e.target.value})}/>

                  <input className="w-full mb-2 p-2 rounded bg-slate-900 border border-slate-700"
                    placeholder="Название"
                    value={newApp.app_name}
                    onChange={e=>setNewApp({...newApp,app_name:e.target.value})}/>

                  <button className="bg-green-600 px-4 py-2 rounded"
                    onClick={registerApp}>
                    <Plus size={16}/> Создать
                  </button>
                </div>

                {apps.map(app=>(
                  <div key={app.app_id} className="bg-slate-800 p-4 rounded-xl">
                    <div className="flex justify-between mb-2">
                      <div>
                        <h3 className="text-lg">{app.app_name}</h3>
                        <p className="text-slate-400 text-sm">ID: {app.app_id}</p>
                      </div>

                      <div className="flex gap-2">
                        <button className="p-2 bg-yellow-600/20 rounded"
                          onClick={()=>regenerateKey("app",app.app_id)}>
                          <RefreshCw/>
                        </button>

                        <button className="p-2 bg-red-600/20 rounded"
                          onClick={()=>deleteItem("app",app.app_id)}>
                          <Trash2/>
                        </button>
                      </div>
                    </div>

                    <div className="bg-slate-900 p-3 rounded">
                      <code className="text-green-400">
                        {showKeys[app.app_id] ? app.app_key : "••••••••••••••••••••••"}
                      </code>

                      <button className="ml-2 p-1"
                        onClick={()=>setShowKeys({...showKeys,[app.app_id]:!showKeys[app.app_id]})}>
                        {showKeys[app.app_id] ? <EyeOff/> : <Eye/>}
                      </button>

                      <button className="ml-1 p-1"
                        onClick={()=>navigator.clipboard.writeText(app.app_key)}>
                        <Copy/>
                      </button>
                    </div>

                    <p className="text-xs text-slate-500 mt-1">
                      Создано: {new Date(app.created_at).toLocaleString("ru-RU")}
                    </p>
                  </div>
                ))}
              </div>
            )}

            {/* Пользователи */}
            {activeTab==="users" && (
              <div className="space-y-4">

                <div className="bg-slate-800 p-4 rounded-xl">
                  <h2 className="text-xl mb-3">Добавить пользователя</h2>

                  <input className="w-full mb-2 p-2 rounded bg-slate-900 border border-slate-700"
                    placeholder="Username"
                    value={newUser.username}
                    onChange={e=>setNewUser({...newUser,username:e.target.value})}/>

                  <input className="w-full mb-2 p-2 rounded bg-slate-900 border border-slate-700"
                    placeholder="User ID (опционально)"
                    value={newUser.user_id}
                    onChange={e=>setNewUser({...newUser,user_id:e.target.value})}/>

                  <select className="w-full mb-2 p-2 rounded bg-slate-900 border border-slate-700"
                    value={newUser.role}
                    onChange={e=>setNewUser({...newUser,role:e.target.value})}>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="readonly">Readonly</option>
                  </select>

                  <button className="bg-blue-600 px-4 py-2 rounded"
                    onClick={registerUser}>
                    <Plus size={16}/> Создать
                  </button>
                </div>

                {users.map(user=>(
                  <div key={user.user_id} className="bg-slate-800 p-4 rounded-xl">
                    <div className="flex justify-between mb-2">
                      <div>
                        <div className="flex gap-2 items-center">
                          <h3 className="text-lg">{user.username}</h3>
                          <span className={`px-2 py-1 rounded text-xs border ${getRoleBadge(user.role)}`}>
                            {user.role}
                          </span>
                        </div>
                        <p className="text-sm text-slate-400">ID: {user.user_id}</p>

                        <select className="mt-2 bg-slate-900 p-1 border border-slate-700 rounded"
                          value={user.role}
                          onChange={e=>updateRole(user.user_id,e.target.value)}>
                          <option value="user">User</option>
                          <option value="admin">Admin</option>
                          <option value="readonly">Readonly</option>
                        </select>
                      </div>

                      <div className="flex gap-2">
                        <button className="p-2 bg-yellow-600/20 rounded"
                          onClick={()=>regenerateKey("user",user.user_id)}>
                          <RefreshCw/>
                        </button>
                        <button className="p-2 bg-red-600/20 rounded"
                          onClick={()=>deleteItem("user",user.user_id)}>
                          <Trash2/>
                        </button>
                      </div>
                    </div>

                    <div className="bg-slate-900 p-3 rounded">
                      <code className="text-blue-400">
                        {showKeys[user.user_id] ? user.user_key : "••••••••••••••••••••"}
                      </code>

                      <button className="ml-2 p-1"
                        onClick={()=>setShowKeys({...showKeys,[user.user_id]:!showKeys[user.user_id]})}>
                        {showKeys[user.user_id] ? <EyeOff/> : <Eye/>}
                      </button>

                      <button className="ml-1 p-1"
                        onClick={()=>navigator.clipboard.writeText(user.user_key)}>
                        <Copy/>
                      </button>
                    </div>

                    <p className="text-xs text-slate-500 mt-1">
                      Создано: {new Date(user.created_at).toLocaleString("ru-RU")}
                    </p>
                  </div>
                ))}
              </div>
            )}

            {/* Доступы */}
            {activeTab==="access" && (
              <div className="space-y-6">
                <div className="bg-slate-800 p-4 rounded-xl">
                  <h2 className="text-xl mb-2">Управление доступами</h2>
                  <p className="text-slate-400 text-sm">
                    Нажми на иконку, чтобы выдать или отозвать доступ.
                  </p>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-slate-700">
                        <th className="p-3 text-left text-slate-400">Пользователь</th>
                        {apps.map(app=>(
                          <th key={app.app_id} className="p-3 text-center text-slate-400">
                            {app.app_name}
                          </th>
                        ))}
                      </tr>
                    </thead>

                    <tbody>
                      {users.map(user=>(
                        <tr key={user.user_id} className="border-b border-slate-800">
                          <td className="p-3">{user.username}</td>

                          {apps.map(app=>(
                            <td key={app.app_id} className="p-3 text-center">
                              <button
                                onClick={()=>toggleAccess(user.user_id,app.app_id,hasAccess(user.user_id,app.app_id))}
                              >
                                {hasAccess(user.user_id,app.app_id)
                                  ? <CheckCircle className="text-green-400"/>
                                  : <XCircle className="text-red-400"/>}
                              </button>
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>

                  </table>
                </div>
              </div>
            )}
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<AdminPanel />);
    </script>
</body>
</html>