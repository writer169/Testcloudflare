<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - D1 Management</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@19",
      "react-dom/client": "https://esm.sh/react-dom@19/client",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1"
    }
  }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState } from 'react';
    import { createRoot } from 'react-dom/client';
    import {
      Plus, Trash2, RefreshCw, Eye, EyeOff,
      Users, Package, Shield, CheckCircle, XCircle,
      Copy, Check
    } from 'lucide-react';

    const AdminPanel = () => {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [masterKey, setMasterKey] = useState('');
      const [baseUrl, setBaseUrl] = useState('https://testcloudflare-t45.pages.dev');

      const [apps, setApps] = useState([]);
      const [users, setUsers] = useState([]);
      const [userApps, setUserApps] = useState([]);

      const [activeTab, setActiveTab] = useState('apps');
      const [showKeys, setShowKeys] = useState({});
      const [copiedKey, setCopiedKey] = useState('');

      const [newApp, setNewApp] = useState({ app_id: '', app_name: '' });
      const [newUser, setNewUser] = useState({ username: '', user_id: '', role: 'user' });

      const apiCall = async (action, payload = {}) => {
        const res = await fetch(`${baseUrl}/api/admin`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${masterKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action, ...payload })
        });
        return res.json();
      };

      const authenticate = async () => {
        if (!masterKey) return alert('Введите мастер-ключ');
        const data = await apiCall('verify');
        if (data.status === 'ok') {
          setIsAuthenticated(true);
          loadData();
        } else {
          alert('Неверный мастер-ключ');
        }
      };

      const loadData = async () => {
        const [a, u, ua] = await Promise.all([
          apiCall('list_apps'),
          apiCall('list_users'),
          apiCall('list_user_apps')
        ]);
        setApps(a?.data || []);
        setUsers(u?.data || []);
        setUserApps(ua?.data || []);
      };

      const registerApp = async () => {
        if (!newApp.app_id || !newApp.app_name) return alert('Заполните все поля');
        const res = await apiCall('register_app', newApp);
        if (res.status === 'ok') {
          setNewApp({ app_id: '', app_name: '' });
          loadData();
          alert(`Приложение создано!\nКлюч:\n${res.app_key}\nСохраните его сейчас!`);
        } else alert(res.message || 'Ошибка');
      };

      const registerUser = async () => {
        if (!newUser.username) return alert('Введите username');
        const res = await apiCall('register_user', newUser);
        if (res.status === 'ok') {
          setNewUser({ username: '', user_id: '', role: 'user' });
          loadData();
          alert(`Пользователь создан!\nID: \( {res.user_id}\nКлюч: \){res.user_key}`);
        } else alert(res.message || 'Ошибка');
      };

      const updateRole = async (userId, role) => {
        const res = await apiCall('update_role', { user_id: userId, role });
        if (res.status === 'ok') loadData();
      };

      const regenerateKey = async (type, id) => {
        if (!confirm('Старый ключ станет недействительным. Продолжить?')) return;
        const action = type === 'app' ? 'regenerate_app_key' : 'regenerate_user_key';
        const field = type === 'app' ? 'app_id' : 'user_id';
        const res = await apiCall(action, { [field]: id });
        if (res.status === 'ok') {
          loadData();
          alert(`Новый ключ:\n${res.new_key}`);
        }
      };

      const deleteItem = async (type, id) => {
        if (!confirm('Удалить навсегда?')) return;
        const action = type === 'app' ? 'delete_app' : 'delete_user';
        const field = type === 'app' ? 'app_id' : 'user_id';
        const res = await apiCall(action, { [field]: id });
        if (res.status === 'ok') loadData();
      };

      const toggleAccess = async (userId, appId, has) => {
        const action = has ? 'revoke_access' : 'grant_access';
        const res = await apiCall(action, { user_id: userId, app_id: appId });
        if (res.status === 'ok') loadData();
      };

      const copyKey = (key) => {
        navigator.clipboard.writeText(key);
        setCopiedKey(key);
        setTimeout(() => setCopiedKey(''), 2000);
      };

      const hasAccess = (userId, appId) => 
        userApps.some(x => x.user_id === userId && x.app_id === appId);

      const getRoleClass = (role) => {
        const map = {
          admin: 'bg-red-500/20 text-red-400 border-red-500/30',
          user: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
          readonly: 'bg-gray-500/20 text-gray-400 border-gray-500/30'
        };
        return map[role] || map.user;
      };

      // ==================== ВХОД ====================
      if (!isAuthenticated) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
            <div className="bg-slate-800/60 backdrop-blur-xl border border-slate-700 rounded-2xl p-10 w-full max-w-md">
              <div className="flex items-center gap-4 mb-8">
                <Shield size={40} className="text-purple-400" />
                <h1 className="text-3xl font-bold">Admin Panel</h1>
              </div>

              <div className="space-y-5">
                <input
                  type="text"
                  placeholder="Base URL"
                  value={baseUrl}
                  onChange={e => setBaseUrl(e.target.value)}
                  className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg"
                />
                <input
                  type="password"
                  placeholder="Master Key"
                  value={masterKey}
                  onChange={e => setMasterKey(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && authenticate()}
                  className="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg"
                />
                <button
                  onClick={authenticate}
                  className="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold"
                >
                  Войти
                </button>
              </div>
            </div>
          </div>
        );
      }

      // ==================== ОСНОВНОЙ ИНТЕРФЕЙС ====================
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 md:p-8">
          <div className="max-w-6xl mx-auto">
            {/* Здесь весь ваш красивый JSX из предыдущего сообщения – просто скопируйте его сюда */}
            {/* Я оставил его без изменений, он полностью рабочий */}
            {/* (всё, что было после if (!isAuthenticated) в вашем оригинальном коде) */}
          </div>
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<AdminPanel />);
  </script>
</body>
</html>